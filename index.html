<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養小達人 - 鏡頭辨識遊戲</title>
    <!-- 引入 TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <!-- 引入 Teachable Machine 模型加載器 -->
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'vitamin-a': '#FF9F43',
                        'vitamin-c': '#FF6B6B',
                        'vitamin-d': '#FDCB6E',
                        'iron': '#78909C'
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none; /* 防止iOS上的橡皮筋效果 */
        }
        
        .nutrient-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .nutrient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        #webcam-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        #webcam-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #webcam-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid transparent;
            border-radius: 0.75rem;
            animation: scanning 2s infinite linear;
            background: linear-gradient(to bottom, transparent, transparent);
            background-size: 100% 200%;
            z-index: 10;
            pointer-events: none;
        }
        
        @keyframes scanning {
            0% {
                background-position: 0 -100%;
                border-color: rgba(93, 92, 222, 0.3);
            }
            50% {
                background-position: 0 200%;
                border-color: rgba(93, 92, 222, 0.8);
            }
            100% {
                background-position: 0 -100%;
                border-color: rgba(93, 92, 222, 0.3);
            }
        }
        
        .answer-animation {
            animation: pop 0.5s ease;
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .dark .dark\:bg-opacity-80 {
            --tw-bg-opacity: 0.8;
        }
        
        .symptom-card {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s;
        }
        
        .symptom-image {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            object-position: center;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 觸控優化 */
        button, a {
            min-height: 44px; /* 觸控元素的最小高度 */
            touch-action: manipulation; /* 優化觸控行為 */
        }
        
        /* 低端設備優化 */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01s !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01s !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* 針對Safari的修復 */
        @supports (-webkit-touch-callout: none) {
            #webcam-container {
                /* Safari需要固定的高度而不是aspect-ratio */
                height: calc(100vw - 2rem);
                max-height: 400px;
            }
        }
        
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 暗模式滾動條 */
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 dark:text-white transition-colors duration-300">
    <div class="container mx-auto px-4 py-4 md:py-8 max-w-screen-lg">
        <!-- 頁面導航 -->
        <nav class="flex flex-wrap justify-between items-center mb-4 md:mb-8 gap-2">
            <div class="flex items-center">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%235D5CDE' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M11 17a1 1 0 0 1 1 1v4h-2v-4a1 1 0 0 1 1-1z'/%3E%3Cpath d='M5 14c0 3 2 4 2 5'/%3E%3Cpath d='M19 9c-3 0-6 3-6 3s-3-3-6-3C4 9 2 11 2 14c0 3.11 5.38 7.39 7 8.3.46.26 1.08.26 1.54 0 1.62-.91 7-5.19 7-8.3 0-3-2-5-5-5z'/%3E%3C/svg%3E" alt="Logo" class="mr-2 w-6 h-6 sm:w-8 sm:h-8">
                <h1 class="text-xl sm:text-2xl font-bold text-primary">營養小達人</h1>
            </div>
            <div class="flex gap-2 sm:gap-4">
                <button id="instructionBtn" class="btn px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition">遊戲說明</button>
                <button id="gameBtn" class="btn px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">開始遊戲</button>
            </div>
        </nav>

        <!-- 遊戲說明頁面 -->
        <div id="instructionSection" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-6">
            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-primary">學習四種營養缺乏病</h2>
            <p class="mb-6 text-sm sm:text-base">在這個遊戲中，你將學習四種重要的營養元素及其缺乏會導致的健康問題。請按照遊戲提示，將正確的食物模型放在相機前方，讓系統辨識！</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <!-- 維生素A -->
                <div class="nutrient-card bg-vitamin-a bg-opacity-10 dark:bg-opacity-20 p-4 rounded-lg border-l-4 border-vitamin-a">
                    <h3 class="text-base sm:text-lg font-bold text-vitamin-a">維生素A</h3>
                    <p class="text-xs sm:text-sm mt-2">缺乏症狀：夜盲症、皮膚乾燥、生長遲緩</p>
                    <p class="text-xs sm:text-sm mt-2">食物來源：胡蘿蔔</p>
                </div>
                
                <!-- 維生素C -->
                <div class="nutrient-card bg-vitamin-c bg-opacity-10 dark:bg-opacity-20 p-4 rounded-lg border-l-4 border-vitamin-c">
                    <h3 class="text-base sm:text-lg font-bold text-vitamin-c">維生素C</h3>
                    <p class="text-xs sm:text-sm mt-2">缺乏症狀：壞血病、牙齦出血、傷口癒合慢</p>
                    <p class="text-xs sm:text-sm mt-2">食物來源：橙</p>
                </div>
                
                <!-- 維生素D -->
                <div class="nutrient-card bg-vitamin-d bg-opacity-10 dark:bg-opacity-20 p-4 rounded-lg border-l-4 border-vitamin-d">
                    <h3 class="text-base sm:text-lg font-bold text-vitamin-d">維生素D</h3>
                    <p class="text-xs sm:text-sm mt-2">缺乏症狀：佝僂病、骨軟化症、骨質疏鬆</p>
                    <p class="text-xs sm:text-sm mt-2">食物來源：蛋黃</p>
                </div>
                
                <!-- 鐵質 -->
                <div class="nutrient-card bg-iron bg-opacity-10 dark:bg-opacity-20 p-4 rounded-lg border-l-4 border-iron">
                    <h3 class="text-base sm:text-lg font-bold text-iron">鐵質</h3>
                    <p class="text-xs sm:text-sm mt-2">缺乏症狀：貧血、疲勞、免疫力下降、注意力不集中</p>
                    <p class="text-xs sm:text-sm mt-2">食物來源：蘋果</p>
                </div>
            </div>

            <div class="mt-6 sm:mt-8 bg-gray-100 dark:bg-gray-700 p-4 rounded-lg text-sm sm:text-base">
                <h3 class="font-bold mb-3">如何遊玩：</h3>
                <ol class="list-decimal pl-6 space-y-2">
                    <li>點擊「開始遊戲」按鈕進入遊戲畫面</li>
                    <li>系統會顯示一種營養缺乏病的症狀</li>
                    <li>將含有該營養素的食物模型放在相機前</li>
                    <li>系統會自動識別並判斷答案是否正確</li>
                    <li>回答所有問題，看看你能得到多少分！</li>
                </ol>
                <p class="mt-4 text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                    提示：確保相機能夠清晰看到食物模型，並且光線充足。
                </p>
            </div>
        </div>

        <!-- 遊戲頁面 -->
        <div id="gameSection" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-6 hidden">
            <div class="flex flex-col">
                <!-- 遊戲狀態 -->
                <div class="flex justify-between mb-4">
                    <div class="text-sm font-medium">
                        問題：<span id="currentQuestion">1</span>/<span id="totalQuestions">5</span>
                    </div>
                    <div class="text-sm font-medium">
                        得分：<span id="score">0</span>
                    </div>
                </div>
                
                <!-- 營養缺乏症狀展示 -->
                <div id="symptomContainer" class="mb-4 sm:mb-6 fade-in">
                    <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-4">觀察以下症狀：</h3>
                    
                    <div class="symptom-card bg-white dark:bg-gray-700 mb-4">
                        <img id="symptomImage" src="" alt="營養缺乏症狀" class="symptom-image">
                        <div class="p-3 sm:p-4">
                            <h4 id="symptomTitle" class="text-base sm:text-lg font-bold"></h4>
                            <p id="symptomDescription" class="text-xs sm:text-sm mt-2"></p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 p-3 sm:p-4 rounded-lg">
                        <p class="text-xs sm:text-sm"><span class="font-bold">問題：</span> <span id="questionText">請將正確的食物模型放在相機前，解決上述營養缺乏問題。</span></p>
                    </div>
                </div>
                
                <!-- 相機和結果區 - 在小螢幕上垂直排列，在中等以上螢幕上水平排列 -->
                <div class="flex flex-col lg:flex-row gap-4 lg:gap-6">
                    <!-- 相機預覽區 -->
                    <div class="w-full lg:w-1/2">
                        <div id="webcam-container" class="bg-gray-200 dark:bg-gray-700 rounded-xl overflow-hidden shadow-inner">
                            <!-- 相機畫布將由JavaScript加入 -->
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div id="webcam-loading" class="flex items-center justify-center py-2">
                                <div class="animate-spin rounded-full h-5 w-5 sm:h-6 sm:w-6 border-b-2 border-primary"></div>
                                <span class="ml-2 text-xs sm:text-sm">相機正在啟動中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 遊戲提示與回饋區 -->
                    <div class="w-full lg:w-1/2 flex flex-col">
                        <!-- 識別結果 -->
                        <div id="resultContainer" class="bg-gray-100 dark:bg-gray-700 p-3 sm:p-4 rounded-lg hidden mb-4">
                            <div id="correctAnswer" class="bg-green-100 dark:bg-green-900 dark:bg-opacity-60 p-2 sm:p-3 rounded-lg mb-3 hidden">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="font-medium text-sm sm:text-base">答對了！</span>
                                </div>
                                <p id="correctText" class="mt-1 text-xs sm:text-sm"></p>
                            </div>
                            
                            <div id="wrongAnswer" class="bg-red-100 dark:bg-red-900 dark:bg-opacity-60 p-2 sm:p-3 rounded-lg mb-3 hidden">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    <span class="font-medium text-sm sm:text-base">再試一次！</span>
                                </div>
                                <p id="wrongText" class="mt-1 text-xs sm:text-sm"></p>
                            </div>
                        </div>
                        
                        <!-- 識別結果列表 -->
                        <div class="bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-lg border border-gray-200 dark:border-gray-700 overflow-auto max-h-60">
                            <div class="text-xs sm:text-sm font-medium mb-2">識別結果：</div>
                            <div id="label-container" class="space-y-2 text-xs sm:text-sm"></div>
                        </div>
                        
                        <!-- 下一題按鈕 -->
                        <button id="nextBtn" class="mt-4 px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition self-center hidden">下一題</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 結果頁面 -->
        <div id="resultSection" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-6 hidden">
            <div class="text-center py-4 sm:py-8">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">遊戲結束！</h2>
                <div class="text-3xl sm:text-4xl md:text-5xl font-bold text-primary mb-6">
                    <span id="finalScore">0</span> / <span id="totalScore">5</span>
                </div>
                <p id="resultMessage" class="text-base sm:text-lg mb-6 sm:mb-8">你做得很棒！繼續努力！</p>
                
                <div class="flex flex-wrap justify-center gap-3 sm:gap-4">
                    <button id="restartBtn" class="px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition">再玩一次</button>
                    <button id="learnMoreBtn" class="px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">學習更多</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 無法訪問相機的提示 -->
    <div id="cameraErrorModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="mx-4 sm:mx-auto bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg max-w-md">
            <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-red-500">相機訪問錯誤</h3>
            <p class="mb-4 sm:mb-6 text-sm sm:text-base">無法訪問您的相機。請確保您已授予相機權限，並且沒有其他應用程序正在使用相機。</p>
            <div class="flex justify-end">
                <button id="errorCloseBtn" class="px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- 模型加載錯誤提示 -->
    <div id="modelErrorModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="mx-4 sm:mx-auto bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg max-w-md">
            <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-red-500">模型加載錯誤</h3>
            <p id="modelErrorText" class="mb-4 sm:mb-6 text-sm sm:text-base">無法加載模型。請確保您輸入了正確的Teachable Machine模型URL。</p>
            <div class="flex justify-end">
                <button id="modelErrorCloseBtn" class="px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- 瀏覽器兼容性提示 -->
    <div id="browserWarningModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="mx-4 sm:mx-auto bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg max-w-md">
            <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-yellow-500">瀏覽器兼容性警告</h3>
            <p class="mb-4 sm:mb-6 text-sm sm:text-base">您的瀏覽器可能不完全支持此應用程序的所有功能。為獲得最佳體驗，建議使用最新版本的Chrome、Firefox或Safari。</p>
            <div class="flex justify-end">
                <button id="browserWarningCloseBtn" class="px-3 py-2 sm:px-4 sm:py-2 text-sm sm:text-base bg-primary text-white rounded-lg hover:bg-opacity-90 transition">我理解了</button>
            </div>
        </div>
    </div>

    <script>
        // 設置深色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 檢查瀏覽器兼容性
        function checkBrowserCompatibility() {
            const isChrome = navigator.userAgent.indexOf("Chrome") > -1;
            const isFirefox = navigator.userAgent.indexOf("Firefox") > -1;
            const isSafari = navigator.userAgent.indexOf("Safari") > -1 && !isChrome;
            const isIE = navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Trident") > -1;
            const isEdge = navigator.userAgent.indexOf("Edge") > -1;
            const isOldBrowser = isIE || (isEdge && !isChrome);

            // 如果是舊瀏覽器或不支持的瀏覽器，顯示警告
            if (isOldBrowser) {
                document.getElementById('browserWarningModal').classList.remove('hidden');
            }
        }

        // 營養素及相關信息
        const nutrients = [
            {
                id: 'vitamin-a',
                name: '維生素A缺乏症',
                title: '夜盲症',
                description: '維生素A缺乏會導致眼睛無法在黑暗中看清物體（夜盲症），還可能引起皮膚乾燥和生長遲緩問題。',
                imageUrl: 'https://images.unsplash.com/photo-1590439471014-a924ff323c10?q=80&w=800&auto=format&fit=crop',
                correctFood: '胡蘿蔔',
                hint: '這種營養素豐富存在於橙黃色蔬菜中，胡蘿蔔就是最佳來源之一。'
            },
            {
                id: 'vitamin-c',
                name: '維生素C缺乏症',
                title: '壞血病',
                description: '維生素C缺乏會導致壞血病，症狀包括牙齦出血、傷口癒合緩慢、皮膚出現瘀斑等問題。',
                imageUrl: 'https://images.unsplash.com/photo-1628426862072-927285554ea6?q=80&w=800&auto=format&fit=crop',
                correctFood: '橙',
                hint: '這種營養素豐富存在於柑橘類水果中，如橙。'
            },
            {
                id: 'vitamin-d',
                name: '維生素D缺乏症',
                title: '佝僂病與骨質疏鬆',
                description: '維生素D缺乏會導致兒童佝僂病（骨骼軟化、彎曲）和成人骨質疏鬆，影響鈣的吸收和骨骼健康。',
                imageUrl: 'https://images.unsplash.com/photo-1579684385127-1ef15d508118?q=80&w=800&auto=format&fit=crop',
                correctFood: '蛋黃',
                hint: '這種營養素可以通過曬太陽產生，也存在於蛋黃中。'
            },
            {
                id: 'iron',
                name: '鐵質缺乏症',
                title: '缺鐵性貧血',
                description: '鐵質缺乏會導致貧血，症狀包括疲勞、臉色蒼白、免疫力下降和注意力不集中等問題。',
                imageUrl: 'https://images.unsplash.com/photo-1614807547894-2b8a91a146c5?q=80&w=800&auto=format&fit=crop',
                correctFood: '蘋果',
                hint: '在我們的學習遊戲中，蘋果代表了鐵質的食物來源。'
            }
        ];

        // DOM 元素
        const instructionSection = document.getElementById('instructionSection');
        const gameSection = document.getElementById('gameSection');
        const resultSection = document.getElementById('resultSection');
        const instructionBtn = document.getElementById('instructionBtn');
        const gameBtn = document.getElementById('gameBtn');
        const nextBtn = document.getElementById('nextBtn');
        const restartBtn = document.getElementById('restartBtn');
        const learnMoreBtn = document.getElementById('learnMoreBtn');
        const resultContainer = document.getElementById('resultContainer');
        const correctAnswer = document.getElementById('correctAnswer');
        const wrongAnswer = document.getElementById('wrongAnswer');
        const correctText = document.getElementById('correctText');
        const wrongText = document.getElementById('wrongText');
        const currentQuestion = document.getElementById('currentQuestion');
        const totalQuestions = document.getElementById('totalQuestions');
        const score = document.getElementById('score');
        const finalScore = document.getElementById('finalScore');
        const totalScore = document.getElementById('totalScore');
        const resultMessage = document.getElementById('resultMessage');
        const webcamLoading = document.getElementById('webcam-loading');
        const webcamContainer = document.getElementById('webcam-container');
        const labelContainer = document.getElementById('label-container');
        const cameraErrorModal = document.getElementById('cameraErrorModal');
        const errorCloseBtn = document.getElementById('errorCloseBtn');
        const modelErrorModal = document.getElementById('modelErrorModal');
        const modelErrorText = document.getElementById('modelErrorText');
        const modelErrorCloseBtn = document.getElementById('modelErrorCloseBtn');
        const browserWarningModal = document.getElementById('browserWarningModal');
        const browserWarningCloseBtn = document.getElementById('browserWarningCloseBtn');
        
        // 症狀顯示元素
        const symptomImage = document.getElementById('symptomImage');
        const symptomTitle = document.getElementById('symptomTitle');
        const symptomDescription = document.getElementById('symptomDescription');
        const questionText = document.getElementById('questionText');

        // Teachable Machine 模型 URL
        const TMModelURL = "https://teachablemachine.withgoogle.com/models/F2iTS4kEr/";

        // 遊戲狀態
        let gameState = {
            currentQuestionIndex: 0,
            currentScore: 0,
            totalQuestions: 5,
            questions: [],
            currentNutrient: null,
            answered: false,
            model: null,
            webcam: null,
            modelLoaded: false,
            webcamRunning: false,
            predictionRunning: false,
            predictionTimeout: null,
            maxPredictions: 0,
            checkingAnswer: false,
            gameReady: false  // 新增狀態標記
        };

        // 頁面導航和按鈕事件
        instructionBtn.addEventListener('click', showInstructions);
        gameBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', nextQuestion);
        restartBtn.addEventListener('click', startGame);
        learnMoreBtn.addEventListener('click', showInstructions);
        errorCloseBtn.addEventListener('click', () => {
            cameraErrorModal.classList.add('hidden');
        });
        modelErrorCloseBtn.addEventListener('click', () => {
            modelErrorModal.classList.add('hidden');
        });
        browserWarningCloseBtn.addEventListener('click', () => {
            browserWarningModal.classList.add('hidden');
        });

        // 頁面加載時檢查瀏覽器兼容性
        window.addEventListener('DOMContentLoaded', checkBrowserCompatibility);

        // 顯示遊戲說明
        function showInstructions() {
            instructionSection.classList.remove('hidden');
            gameSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            instructionBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            instructionBtn.classList.add('bg-primary', 'text-white');
            gameBtn.classList.remove('bg-primary', 'text-white');
            gameBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');

            // 如果有相機運行，停止它
            stopGameElements();
        }

        // 開始遊戲
        async function startGame() {
            try {
                // 禁用按鈕，防止重複點擊
                gameBtn.disabled = true;
                gameBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                // 更新UI
                instructionSection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                resultSection.classList.add('hidden');
                gameBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                gameBtn.classList.add('bg-primary', 'text-white');
                instructionBtn.classList.remove('bg-primary', 'text-white');
                instructionBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                
                // 重置遊戲狀態
                gameState.currentQuestionIndex = 0;
                gameState.currentScore = 0;
                gameState.answered = false;
                gameState.checkingAnswer = false;
                gameState.gameReady = false;
                
                // 生成隨機問題
                gameState.questions = [];
                const shuffledNutrients = [...nutrients].sort(() => Math.random() - 0.5);
                for (let i = 0; i < gameState.totalQuestions; i++) {
                    gameState.questions.push(shuffledNutrients[i % shuffledNutrients.length]);
                }
                
                // 更新UI
                currentQuestion.textContent = '1';
                totalQuestions.textContent = gameState.totalQuestions;
                score.textContent = '0';
                
                // 清空標籤容器
                labelContainer.innerHTML = '';
                
                // 初始化相機和模型
                await initializeModelAndWebcam();
                
                // 顯示第一個問題
                showCurrentQuestion();
                
                // 恢復按鈕
                gameBtn.disabled = false;
                gameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // 標記遊戲已就緒
                gameState.gameReady = true;
            } catch (error) {
                console.error("遊戲啟動錯誤:", error);
                
                // 恢復按鈕狀態
                gameBtn.disabled = false;
                gameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // 根據錯誤類型顯示適當的錯誤訊息
                if (error.message.includes('camera')) {
                    cameraErrorModal.classList.remove('hidden');
                } else {
                    modelErrorText.textContent = "遊戲啟動發生錯誤：" + error.message;
                    modelErrorModal.classList.remove('hidden');
                }
            }
        }

        // 初始化模型和相機
        async function initializeModelAndWebcam() {
            webcamLoading.classList.remove('hidden');
            
            try {
                // 載入模型
                const modelURL = TMModelURL + "model.json";
                const metadataURL = TMModelURL + "metadata.json";
                
                // 載入模型和元數據
                gameState.model = await tmImage.load(modelURL, metadataURL);
                gameState.maxPredictions = gameState.model.getTotalClasses();
                gameState.modelLoaded = true;
                
                // 計算相機容器的大小，保持正方形
                const containerWidth = webcamContainer.clientWidth;
                const size = Math.min(containerWidth, 400); // 限制最大尺寸為400px
                
                // 設置網絡攝像頭
                const flip = true; // 是否翻轉相機
                gameState.webcam = new tmImage.Webcam(size, size, flip);
                await gameState.webcam.setup();
                await gameState.webcam.play();
                gameState.webcamRunning = true;
                
                // 將元素添加到DOM
                webcamContainer.innerHTML = ''; // 清空容器
                webcamContainer.appendChild(gameState.webcam.canvas);
                gameState.webcam.canvas.id = 'webcam-canvas';
                
                // 設置標籤容器
                labelContainer.innerHTML = '';
                for (let i = 0; i < gameState.maxPredictions; i++) {
                    const predItem = document.createElement('div');
                    predItem.className = 'flex items-center justify-between p-2 mb-2 rounded-lg bg-gray-100 dark:bg-gray-700';
                    labelContainer.appendChild(predItem);
                }
                
                webcamLoading.classList.add('hidden');
                
                // 開始預測循環
                window.requestAnimationFrame(loop);
            } catch (error) {
                webcamLoading.classList.add('hidden');
                console.error("初始化錯誤:", error);
                
                if (error.name === "NotAllowedError" || error.message.includes("camera") || error.message.includes("permission")) {
                    throw new Error("相機權限被拒絕。請允許網站訪問您的相機。");
                } else if (error.message.includes("model")) {
                    throw new Error("無法加載模型。請檢查網絡連接或刷新頁面重試。");
                } else {
                    throw error;
                }
            }
        }

        // 預測循環
        async function loop() {
            if (!gameState.webcamRunning || !gameState.gameReady) return;
            
            gameState.webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        // 預測函數
        async function predict() {
            if (!gameState.modelLoaded || !gameState.webcamRunning || !gameState.model || 
                !gameState.webcam.canvas || gameState.webcam.canvas.width === 0) {
                return;
            }
            
            try {
                // 進行預測
                const predictions = await gameState.model.predict(gameState.webcam.canvas);
                
                // 更新顯示預測結果
                updatePredictionDisplay(predictions);
                
                // 檢查答案（如果尚未回答）
                if (!gameState.answered && !gameState.checkingAnswer && gameState.gameReady) {
                    checkPredictionForAnswer(predictions);
                }
            } catch (error) {
                console.error("預測錯誤:", error);
            }
        }

        // 更新預測顯示
        function updatePredictionDisplay(predictions) {
            // 獲取正確的食物
            const correctFood = gameState.currentNutrient ? gameState.currentNutrient.correctFood : '';
            
            // 按概率排序預測結果
            predictions.sort((a, b) => b.probability - a.probability);
            
            // 確保標籤容器有足夠的子元素
            while (labelContainer.children.length < predictions.length) {
                const predItem = document.createElement('div');
                predItem.className = 'flex items-center justify-between p-2 mb-2 rounded-lg bg-gray-100 dark:bg-gray-700';
                labelContainer.appendChild(predItem);
            }
            
            // 更新每個預測結果的顯示
            for (let i = 0; i < predictions.length; i++) {
                const prediction = predictions[i];
                const predictionItem = labelContainer.children[i];
                
                // 重置樣式
                predictionItem.className = 'flex items-center justify-between p-2 mb-2 rounded-lg ' + 
                    (prediction.className === correctFood ? 'bg-green-100 dark:bg-green-900 dark:bg-opacity-30' : 'bg-gray-100 dark:bg-gray-700');
                
                // 清空現有內容
                predictionItem.innerHTML = '';
                
                // 添加名稱
                const nameSpan = document.createElement('span');
                nameSpan.textContent = prediction.className;
                nameSpan.className = 'font-medium ' + 
                    (prediction.className === correctFood ? 'text-green-700 dark:text-green-300' : '');
                
                // 添加概率條和數值
                const probContainer = document.createElement('div');
                probContainer.className = 'flex items-center gap-2';
                
                const probBar = document.createElement('div');
                probBar.className = 'w-16 sm:w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2';
                
                const probFill = document.createElement('div');
                probFill.className = prediction.className === correctFood ? 
                    'bg-green-500 h-2 rounded-full' : 'bg-blue-500 h-2 rounded-full';
                probFill.style.width = `${Math.round(prediction.probability * 100)}%`;
                
                const probText = document.createElement('span');
                probText.className = 'text-xs text-gray-500 dark:text-gray-400 w-9 text-right';
                probText.textContent = `${Math.round(prediction.probability * 100)}%`;
                
                probBar.appendChild(probFill);
                probContainer.appendChild(probBar);
                probContainer.appendChild(probText);
                
                predictionItem.appendChild(nameSpan);
                predictionItem.appendChild(probContainer);
                
                // 添加動畫效果
                if (!predictionItem.classList.contains('answer-animation')) {
                    predictionItem.classList.add('answer-animation');
                }
            }
            
            // 隱藏多餘的預測項
            for (let i = predictions.length; i < labelContainer.children.length; i++) {
                labelContainer.children[i].style.display = 'none';
            }
        }

        // 根據預測結果檢查答案
        function checkPredictionForAnswer(predictions) {
            if (!gameState.currentNutrient) return;
            
            // 獲取正確的食物
            const correctFood = gameState.currentNutrient.correctFood;
            
            // 找到最高概率的預測
            const topPrediction = predictions[0];
            
            // 如果最高機率超過閾值且是正確答案
            if (topPrediction.probability > 0.7 && topPrediction.className === correctFood) {
                gameState.checkingAnswer = true;
                
                // 延遲檢查，確保預測穩定
                setTimeout(() => {
                    if (!gameState.answered) {
                        checkAnswer(predictions);
                    }
                    gameState.checkingAnswer = false;
                }, 1200); // 稍微增加延遲，確保預測穩定
            }
        }

        // 檢查答案
        function checkAnswer(predictions) {
            // 設置為已回答
            gameState.answered = true;
            
            // 顯示結果容器
            resultContainer.classList.remove('hidden');
            
            // 獲取正確的食物
            const correctFood = gameState.currentNutrient.correctFood;
            const topPrediction = predictions[0];
            const isCorrect = topPrediction.className === correctFood;
            
            if (isCorrect) {
                // 答對了
                correctAnswer.classList.remove('hidden');
                wrongAnswer.classList.add('hidden');
                correctText.textContent = `太棒了！${topPrediction.className}確實含有豐富的${gameState.currentNutrient.name.replace('缺乏症', '')}，可以預防${gameState.currentNutrient.name}。${gameState.currentNutrient.hint}`;
                
                // 加分
                gameState.currentScore++;
                score.textContent = gameState.currentScore;
            } else {
                // 答錯了
                correctAnswer.classList.add('hidden');
                wrongAnswer.classList.remove('hidden');
                wrongText.textContent = `${topPrediction.className}不是${gameState.currentNutrient.name.replace('缺乏症', '')}的好來源。正確答案是${correctFood}。${gameState.currentNutrient.hint}`;
            }
            
            // 顯示下一題按鈕
            nextBtn.classList.remove('hidden');
        }

        // 顯示當前問題
        function showCurrentQuestion() {
            // 重置狀態
            gameState.answered = false;
            gameState.checkingAnswer = false;
            resultContainer.classList.add('hidden');
            correctAnswer.classList.add('hidden');
            wrongAnswer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            
            // 獲取當前問題
            gameState.currentNutrient = gameState.questions[gameState.currentQuestionIndex];
            
            // 更新症狀信息
            symptomImage.src = gameState.currentNutrient.imageUrl;
            symptomImage.alt = gameState.currentNutrient.title;
            symptomTitle.textContent = gameState.currentNutrient.title;
            symptomDescription.textContent = gameState.currentNutrient.description;
            
            // 更新問題文字
            questionText.textContent = `請將${gameState.currentNutrient.correctFood}放在相機前，幫助解決${gameState.currentNutrient.name}。`;
            
            // 更新問題計數
            currentQuestion.textContent = gameState.currentQuestionIndex + 1;
            
            // 添加淡入效果
            document.getElementById('symptomContainer').classList.add('fade-in');
        }

        // 下一題
        function nextQuestion() {
            // 隱藏下一題按鈕
            nextBtn.classList.add('hidden');
            
            // 增加問題索引
            gameState.currentQuestionIndex++;
            
            // 檢查是否還有更多問題
            if (gameState.currentQuestionIndex < gameState.totalQuestions) {
                showCurrentQuestion();
            } else {
                showResults();
            }
        }

        // 顯示結果
        function showResults() {
            // 更新UI
            instructionSection.classList.add('hidden');
            gameSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // 更新結果
            finalScore.textContent = gameState.currentScore;
            totalScore.textContent = gameState.totalQuestions;
            
            // 更新結果訊息
            if (gameState.currentScore === gameState.totalQuestions) {
                resultMessage.textContent = '太棒了！你是營養小天才！';
            } else if (gameState.currentScore >= gameState.totalQuestions * 0.7) {
                resultMessage.textContent = '做得很好！你對營養知識有很好的理解！';
            } else if (gameState.currentScore >= gameState.totalQuestions * 0.4) {
                resultMessage.textContent = '還不錯！繼續學習更多營養知識吧！';
            } else {
                resultMessage.textContent = '需要多學習一下營養知識哦！再試一次！';
            }
            
            // 停止相機和遊戲元素
            stopGameElements();
        }

        // 停止所有遊戲元素
        function stopGameElements() {
            // 停止相機
            if (gameState.webcam && gameState.webcamRunning) {
                gameState.webcam.stop();
                gameState.webcamRunning = false;
            }
            
            // 標記遊戲未就緒
            gameState.gameReady = false;
        }

        // 添加窗口大小調整處理，以確保相機視窗大小正確
        window.addEventListener('resize', function() {
            if (gameState.webcam && gameState.webcamRunning) {
                // 僅當有顯著大小變化時才調整
                const newWidth = webcamContainer.clientWidth;
                const currentWidth = gameState.webcam.canvas.width;
                
                // 如果尺寸變化超過50px，重新初始化相機
                if (Math.abs(newWidth - currentWidth) > 50) {
                    // 這裡只調整顯示大小，不重新初始化相機
                    // 因為重新初始化相機會導致閃爍和權限問題
                    const newSize = Math.min(newWidth, 400);
                    gameState.webcam.canvas.style.width = `${newSize}px`;
                    gameState.webcam.canvas.style.height = `${newSize}px`;
                }
            }
        });

        // 處理頁面可見性變化，優化資源使用
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 頁面不可見時，暫停相機以節省資源
                if (gameState.webcam && gameState.webcamRunning) {
                    gameState.webcam.pause();
                }
            } else {
                // 頁面可見時，如果之前相機在運行，則恢復
                if (gameState.webcam && gameState.webcamRunning) {
                    gameState.webcam.play();
                }
            }
        });

        // 初始化
        showInstructions();
    </script>
</body>
</html>
